{
  "type": "object",
  "additionalProperties": false,
  "required": [
    "entry_type",
    "summary",
    "details_bullets",
    "tags",
    "goal_links",
    "observations",
    "actions",
    "tool_calls",
    "needs_followup",
    "followup_questions",
    "confidence",
    "topic_assignments",
    "idea_links"
  ],
  "properties": {
    "entry_type": {
      "type": "string",
      "enum": ["activity", "sleep", "food", "thought", "idea", "todo", "goal", "note", "chat"]
    },
    "summary": { "type": "string" },
    "details_bullets": {
      "type": "array",
      "items": { "type": "string" }
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" }
    },
    "goal_links": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["goal_id", "link_type"],
        "properties": {
          "goal_id": { "type": "string" },
          "link_type": { "type": "string", "enum": ["related", "evidence", "blocker", "milestone"] }
        }
      }
    },
    "observations": {
      "type": "object",
      "additionalProperties": false,
      "required": ["activity", "sleep", "food", "weight"],
      "properties": {
        "activity": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["observed_at", "steps", "duration_min", "distance_km", "location", "calories", "pace", "notes", "confidence"],
            "properties": {
              "observed_at": { "type": "string" },
              "steps": { "type": ["integer", "null"] },
              "duration_min": { "type": ["number", "null"] },
              "distance_km": { "type": ["number", "null"] },
              "location": { "type": ["string", "null"] },
              "calories": { "type": ["number", "null"] },
              "pace": { "type": ["string", "null"] },
              "notes": { "type": ["string", "null"] },
              "confidence": { "type": "number" }
            }
          }
        },
        "sleep": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["sleep_start", "sleep_end", "duration_min", "quality", "notes", "confidence"],
            "properties": {
              "sleep_start": { "type": "string" },
              "sleep_end": { "type": "string" },
              "duration_min": { "type": ["number", "null"] },
              "quality": { "type": ["integer", "null"] },
              "notes": { "type": ["string", "null"] },
              "confidence": { "type": "number" }
            }
          }
        },
        "food": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["observed_at", "meal_type", "items", "notes", "confidence"],
            "properties": {
              "observed_at": { "type": "string" },
              "meal_type": { "type": "string", "enum": ["breakfast", "lunch", "dinner", "snack", "other"] },
              "items": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["name", "quantity", "unit", "calories_estimate"],
                  "properties": {
                    "name": { "type": "string" },
                    "quantity": { "type": ["number", "null"] },
                    "unit": { "type": ["string", "null"] },
                    "calories_estimate": { "type": ["number", "null"] }
                  }
                }
              },
              "notes": { "type": ["string", "null"] },
              "confidence": { "type": "number" }
            }
          }
        },
        "weight": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["measured_at", "weight_kg", "confidence"],
            "properties": {
              "measured_at": { "type": "string" },
              "weight_kg": { "type": "number" },
              "confidence": { "type": "number" }
            }
          }
        }
      }
    },
    "actions": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["title", "priority", "status", "due_date", "goal_id", "rationale"],
        "properties": {
          "title": { "type": "string" },
          "goal_id": { "type": ["string", "null"] },
          "due_date": { "type": ["string", "null"] },
          "priority": { "type": "string", "enum": ["low", "medium", "high"] },
          "status": { "type": ["string", "null"], "enum": ["open", "in_progress", "done", "cancelled", null] },
          "rationale": { "type": ["string", "null"] }
        }
      }
    },
    "tool_calls": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["name", "arguments"],
        "properties": {
          "name": { "type": "string", "enum": ["resolve_relative_due_date", "set_due_date"] },
          "arguments": {
            "type": "object",
            "additionalProperties": false,
            "required": ["action_index", "offset_days", "date"],
            "properties": {
              "action_index": { "type": "integer" },
              "offset_days": { "type": ["integer", "null"] },
              "date": { "type": ["string", "null"] }
            }
          }
        }
      }
    },
    "needs_followup": { "type": "boolean" },
    "followup_questions": {
      "type": "array",
      "items": { "type": "string" }
    },
    "confidence": { "type": "number" },
    "topic_assignments": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["area_name", "topic_name", "create_if_new"],
        "properties": {
          "area_name": { "type": "string" },
          "topic_name": { "type": "string" },
          "create_if_new": { "type": "boolean" }
        }
      }
    },
    "idea_links": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["mode", "idea_id", "new_title", "new_description"],
        "properties": {
          "mode": { "type": "string", "enum": ["existing", "new"] },
          "idea_id": { "type": ["string", "null"] },
          "new_title": { "type": ["string", "null"] },
          "new_description": { "type": ["string", "null"] }
        }
      }
    }
  }
}
