{% extends "base.html" %}
{% block content %}
    {% include "fragments/workflow_bar.html" %}
    <section class="panel">
      <h3>Create Thread</h3>
      <form hx-post="/api/chat/threads?format=html" hx-target="#chat-threads" hx-swap="innerHTML">
        <div class="grid">
          <div>
            <label for="thread-title">Title</label>
            <input id="thread-title" name="title" required placeholder="Goal coaching session">
          </div>
          <div>
            <label for="thread-goal-id">Goal</label>
            <select id="thread-goal-id" name="goal_id">
              <option value="">-- none --</option>
              {% for g in goals %}<option value="{{ g.goal_id }}">{{ g.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="toolbar">
          <button type="submit">Create Thread</button>
        </div>
      </form>
    </section>
    <div class="split-pane">
      <div class="split-left">
        <section class="panel">
          <h3>Threads</h3>
          <div
            id="chat-threads"
            hx-get="/api/chat/threads?format=html"
            hx-trigger="load"
            hx-swap="innerHTML"
          ></div>
        </section>
      </div>
      <div class="split-right">
        <section class="panel">
          <h3>Messages</h3>
          <form hx-get="/api/chat/threads/{{{{thread_id}}}}/messages?format=html" hx-target="#chat-messages" hx-swap="innerHTML"
                onsubmit="event.preventDefault(); const tid=document.getElementById('chat-thread-id').value.trim(); if(!tid){return;} htmx.ajax('GET','/api/chat/threads/'+encodeURIComponent(tid)+'/messages?format=html',{target:'#chat-messages',swap:'innerHTML'});">
              <label for="chat-thread-id">Thread ID</label>
              <input id="chat-thread-id" placeholder="chat-...">
              <div class="toolbar">
                <button type="submit">Load Messages</button>
                <button type="button" onclick="const tid=document.getElementById('chat-thread-id').value.trim(); if(!tid){return;} htmx.ajax('POST','/api/chat/threads/'+encodeURIComponent(tid)+'/reply?format=html',{target:'#chat-messages',swap:'innerHTML'});">Generate Reply</button>
                <button type="button" onclick="const tid=document.getElementById('chat-thread-id').value.trim(); if(!tid){return;} htmx.ajax('POST','/api/chat/threads/'+encodeURIComponent(tid)+'/distill?format=html',{target:'#chat-distill',swap:'innerHTML'});">Distill Outcomes</button>
              </div>
          </form>
          <form
            onsubmit="event.preventDefault(); const tid=document.getElementById('chat-thread-id').value.trim(); if(!tid){return;} htmx.ajax('POST','/api/chat/threads/'+encodeURIComponent(tid)+'/messages?format=html',{target:'#chat-messages',swap:'innerHTML',values:{role:document.getElementById('chat-role').value,content:document.getElementById('chat-content').value}});"
          >
            <div class="grid">
              <div>
                <label for="chat-role">Role</label>
                <select id="chat-role">
                  <option value="user">user</option>
                  <option value="assistant">assistant</option>
                  <option value="system">system</option>
                  <option value="tool">tool</option>
                </select>
              </div>
            </div>
            <label for="chat-content">Content</label>
            <textarea id="chat-content" required></textarea>
            <div class="toolbar">
              <button type="submit">Add Message</button>
            </div>
          </form>
          <div id="chat-distill"></div>
          <div id="chat-messages">
            <p>Load a thread to view transcript.</p>
          </div>
        </section>
      </div>
    </div>
    <section class="panel">
      <h3>Goal Context</h3>
      <form onsubmit="event.preventDefault(); const gid=document.getElementById('chat-context-goal').value.trim(); htmx.ajax('GET','/api/chat/context?goal_id='+encodeURIComponent(gid),{target:'#chat-context',swap:'innerHTML'});">
        <label for="chat-context-goal">Goal</label>
        <select id="chat-context-goal">
          <option value="">-- none --</option>
          {% for g in goals %}<option value="{{ g.goal_id }}">{{ g.name }}</option>
          {% endfor %}
        </select>
        <div class="toolbar">
          <button type="submit">Build Context</button>
        </div>
      </form>
      <pre id="chat-context">Run context builder to inspect goal rules, metrics, and recent linked entries.</pre>
    </section>
{% endblock %}
{% block extra_scripts %}
    <script>
      document.body.addEventListener('htmx:afterRequest', function (evt) {
        if (evt.detail && evt.detail.xhr && evt.detail.target && evt.detail.target.id === 'chat-context') {
          try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            evt.detail.target.textContent = JSON.stringify(data, null, 2);
          } catch (e) {}
        }
      });
    </script>
{% endblock %}
